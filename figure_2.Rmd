# Figure 2

## Relevant criticisms

- 3.1.b
  - Power calculations
- 3.1.d
  - Compute effect sizes and 95% CI
- 3.2
  - Add confounders
- 3.3
  - Control a more stringent error rate
- 7
  - Sharing raw data
    - Link raw data to raw data used to re-generate analyses

## Proposed approach


### Effect size and confidence intervals

- Use the `quantreg` package 

- Questions
  - Do we want to put the effect sizes for age in a figure in the supp
  - Do we want to add confounders? (address point 3.2)
    - If they do explain some of the variation, they may make the analysis slightly more powerful (not that this is of particular relevance, but it may help)


- Given that there are not many comparisons (making the BH less reliable) and the Bonferroni would probably give you basically the same results, I suggest using the Bonferroni
- Also since power calc is much easier using Bonferroni (see below)

### Power calculation

- Power relative to:
  - Difference in medians
  - Probability of obs from one group exceeding obs from another group
- Method
  - Could simply simulate
  - Much easier to do this when correcting using Bonferroni method, as the probability of picking a difference up depends on the actual differences in other tests, which obviously complicates things

### Interpreting negative results

- Comment 3.1.c says that the paper should acknowledge that clinically-relevant differences may have been missed due to a lack of power
  - Of course that's always true, but I think that the degree to which this is likely may be addressed in the following way
    - For each non-significant finding:
      - Calculate the 95% CI for the effect size
      - Divide the upper and lower bounds by the standard deviation of the response
      - This gives an estimate of the range of signal-to-noise values that are plausible given the data
      - If these values are all small, then it would seem unlikely that vaccination can induce a clinically relevant effect by modulating this immune response, as clearly there is a lot else that influences this immune response
  - He may counter that some of the noise is due to measurement error, but oh well
    - This is relevant primarily for the very rare subsets, but not so much for the non-rare ones
    - The modelling approach used would "adjust" for the rarity of the cells making estimation of the actual frequency for a person harder, anyway
  - Using this approach, one can rule out very large effect sizes
- Questions
  - Not quite clear what a reasonable scale would be
    - Log10? Square root? Identity?
    
### Miscellaneous

- Figure generation
  - I can export the data for plotting, which Anele and/or Melisa (AM) can then create figures from
- Data sharing
  - I would put whatever data I use into a folder, `DataRawGelaDURT`, and then the processed data into an R package called `DataTidyGelaDURT` that uses `DataRawGelaDURT`. 
    - Open to other names (from Data[Raw/Tidy] onwards)

## Data exploration

```{r }
library(quantreg)
library(magrittr)
library(ggplot2)
data_tidy_freq <- DataTidyGelaDURT::data_tidy_freq %>%
  tibble::as_tibble()
data_tidy_clin_infant <- DataTidyGelaDURT::data_tidy_clin_infant
data_mod_freq_infant <- data_tidy_freq %>%
  dplyr::filter(grepl("infant", pid)) %>%
  dplyr::left_join(
    data_tidy_clin_infant %>%
      dplyr::select(-bcg), 
    by = "pid"
  )
data_tidy_clin_adult <- DataTidyGelaDURT::data_tidy_clin_adult
data_mod_freq_adult <- data_tidy_freq %>%
  dplyr::filter(grepl("adult", pid)) %>%
  dplyr::left_join(
    data_tidy_clin_adult, 
    by = "pid"
  )
```

```{r }
short_to_long_pop <- c(
  "cd1b" = "CD1b", 
  "cd4" = "CD4", 
  "cd4_ifng" = "CD4 IFNg", 
  "gd" = "TCRgd", 
  "gem" = "GEM", 
  "mait" = "MAIT", 
  "nkt" = "NKT"
)
short_to_long_var_cont <- c(
  "gest_age" = "Gest. age", 
  "head_circ" = "Head circ.", 
  "length" = "Length", 
  "visit_age" = "Visit age", 
  "weight" = "Weight", 
  "age_in_years" = "Age (years)", 
  "hgbval" = "HGB", 
  "height" = "Height (cm)", 
  "weight" = "Weight (kg)", 
  "ppd" = "PPD (mm)"
)
short_to_display_bcg <- c(
  "bcg" = "BCG", 
  "no bcg" = "No BCG", 
  "nobcg" = "No BCG", 
  "before" = "Before", 
  "after" = "After"
)
short_to_display_sex <- c(
  "female" = "Female", 
  "male" = "Male", 
  "unknown" = "Unknown"
)
pop_vec <- unique(results_tbl_fig2_infant$pop)

conf <- names(conf_vec_infant)[1]
bcg_to_col <- c(
  "no bcg" = "red", 
  "bcg" = "dodgerblue"
)
trt_to_col <- c(
  "No BCG" = "red", 
  "BCG" = "dodgerblue",
  "Before" = "red", 
  "After" = "dodgerblue"
)
pop_to_lab_freq <- c(
  "mait" = "CD3+ MAIT cells (%)",
  "nkt" = "CD3+ NKT cells (%)",
  "cd1b" = "CD3+ CD1b-GMM+ T cells (%)",
  "gem" = "CD3+ GEM T cells (%)",
  "gd" = "CD3+ gdTCR+ (%)",
  "cd4" = "CD4+ T cells (%)",
  "cd4_ifng" = "IFNg+CD4+ T cells (%)"
)
pop_to_lab_freq <- c(
  "mait" = bquote(paste(plain(paste("CD3+ MAIT cells (%)")))), 
  "nkt" = bquote(paste(plain(paste("CD3+ NKT cells (%)")))),
  "cd1b" = bquote(paste(plain(paste("CD3+ CD1b-GMM+ T cells (%)")))),
  "gem" = bquote(paste(plain(paste("CD3+ GEM T cells (%)")))),
  "gd" = bquote(paste(plain(paste("CD3+ ")), gamma, delta, plain(paste("TCR+ cells (%)")))), 
  "cd4" = bquote(paste(plain(paste("CD4+ T cells (%)")))), 
  "cd4_ifng" = bquote(paste(plain(paste("IFN")), gamma, plain(paste("+CD4+ T cells (%)"))))
)

pop_to_lab_freq_diff <- c(
  "mait" = bquote(paste(plain(paste("Standardised ")), Delta, plain(paste(" BCG")))), 
  "nkt" = bquote(paste(plain(paste("Standardised ")), Delta, plain(paste(" BCG")))),
  "cd1b" = bquote(paste(plain(paste("Standardised ")), Delta, plain(paste(" BCG")))),
  "gem" = bquote(paste(plain(paste("Standardised ")), Delta, plain(paste(" BCG")))),
  "gd" = bquote(paste(plain(paste("Standardised ")), Delta, plain(paste(" BCG")))), 
  "cd4" = bquote(paste(plain(paste("Standardised ")), Delta, plain(paste(" BCG")))), 
  "cd4_ifng" = bquote(paste(plain(paste("Standardised ")), Delta, plain(paste(" BCG"))))
)

short_to_display_age <- c("infant" = "Infant", "adult" = "Adult", 
                          "Infant" = "Infant", "Adult" = "Adult")
```

### Infants

#### Response against BCG status

```{r }
ggplot(data_mod_freq_infant %>%
         dplyr::mutate(
           bcg = factor(
             bcg, 
             levels = c("no bcg", "bcg")
           )
         ), 
       aes(x = bcg, y = freq, fill = bcg)) +
  cowplot::theme_cowplot() +
  cowplot::background_grid(major = "y") +
  geom_boxplot(outlier.size = 1, 
               outlier.colour = "gray55") + 
  scale_fill_brewer(palette = "Set1", 
                    labels = short_to_display_bcg, 
                    name = "BCG") + 
  theme(axis.ticks.x = element_blank(), 
        axis.text.x = element_blank(), 
        legend.title = element_blank(), 
        legend.position = "bottom") + 
  labs(x = "BCG status", y = "Frequency") + 
  facet_wrap(~pop, ncol = 4, scales = "free_y", 
             labeller = labeller(
               pop = short_to_long_pop, 
               conf_cont = short_to_long_var_cont)) 
```


#### Confounders

##### Continuous

###### Response against variable

CD1b and NKT responses possibly depend on visit age. 

```{r }
data_plot_freq_infant_cont <- data_mod_freq_infant %>%
  dplyr::select(-(age:sex)) %>%
  tidyr::pivot_longer(
    gest_age:visit_age, 
    names_to = "conf_cont", 
    values_to = "value"
  )
p_cont <- ggplot(
  data_plot_freq_infant_cont, 
  aes(x = value, y = freq)
) +
  cowplot::theme_cowplot() +
  cowplot::background_grid(major = "y") +
  geom_point() +
  geom_smooth(method = "loess", formula = y ~ x) +
  facet_grid(pop ~ conf_cont, 
             scales = "free", 
             labeller = labeller(
               pop = short_to_long_pop, 
               conf_cont = short_to_long_var_cont)) +
  theme(strip.background = element_blank()) +
  scale_colour_brewer(palette = "Dark2", 
                      labels = short_to_display_bcg) +
  labs(x = "Value", y = "Frequency") +
  theme(legend.title = element_blank()) +
  geom_hline(yintercept = 0)
dir.create(here::here(
    "figures",
    "fig_2", 
    "data_exp"), recursive = TRUE)
cowplot::ggsave2(
  here::here(
    "figures",
    "fig_2", 
    "data_exp", 
    "p-infant-resp_vs_conf_cont.png"
  ), 
  p_cont, 
  height = 20, 
  width = 20, 
  units = "cm"
)
```

```{r , results = "asis"}
knitr::include_graphics("figures/fig_2/data_exp/p-infant-resp_vs_conf_cont.png")
```

###### Variable by BCG status

BCG papers appear slightly longer with slightly higher gestational ages, and are possibly heavier.

```{r }
ggplot(
  data_plot_freq_infant_cont %>%
    dplyr::group_by(conf_cont) %>%
    dplyr::mutate(value = (value - mean(value, na.rm = TRUE)) / sd(value, na.rm = TRUE)) %>%
    dplyr::ungroup(), 
  aes(x = value, col = bcg)
) +
  cowplot::theme_cowplot() +
  cowplot::background_grid(major = "y") +
  # geom_histogram(position = "dodge") +
  geom_density(bw = 0.4) +
  facet_wrap( ~ conf_cont, 
             ncol = 3, 
             scales = "free",
             labeller = labeller(
               pop = short_to_long_pop, 
               conf_cont = short_to_long_var_cont)) +
    scale_colour_brewer(palette = "Dark2", 
                      labels = short_to_display_bcg) +
    labs(x = "Standardised value", y = "Density") +
  theme(strip.background = element_blank()) +
    theme(legend.title = element_blank())
```

#### Categorical

###### Response against variable

####### Race

Appears to be strong race effects.

```{r }
ggplot(
  data_mod_freq_infant, 
  aes(x = bcg, y = freq, fill = race, col = race)
) +
  cowplot::theme_cowplot() +
  cowplot::background_grid(major = "y") +
  geom_jitter(position = "dodge") +
  geom_boxplot(
    position = "dodge", 
    col = "black", 
    outlier.size = -1
  ) +
  facet_wrap(~pop, 
             ncol = 4, 
             scales = "free_y", 
             labeller = labeller(
               pop = short_to_long_pop, 
               conf_cont = short_to_long_var_cont))  +
  scale_fill_brewer(palette = "Set1", 
                    name = "Race") +
  scale_colour_brewer(palette = "Set1", 
                      name = "Race") +
  scale_x_discrete(labels = short_to_display_bcg) +
  labs(x = "BCG status", y = "Frequency")
```

####### Gender

Appears to be strong sex effect as well, if not as strong as race.

```{r }
ggplot(
  data_mod_freq_infant %>%
    dplyr::mutate(sex = ifelse(is.na(sex), "unknown", sex)), 
  aes(x = bcg, y = freq, fill = sex, col = sex)
) +
  cowplot::theme_cowplot() +
  cowplot::background_grid(major = "y") +
  geom_jitter(position = "dodge") +
  geom_boxplot(
    position = "dodge", 
    col = "black", 
    outlier.size = -1
  ) +
  facet_wrap(~pop, 
             ncol = 4, 
             scales = "free_y", 
             labeller = labeller(
               pop = short_to_long_pop,
               sex = short_to_display_sex
             ))  +
  scale_fill_brewer(palette = "Set2", 
                    name = "Sex",
                    labels = short_to_display_sex) +
  scale_colour_brewer(palette = "Set2", 
                      name = "Sex",
                      labels = short_to_display_sex)
```

### Adults

#### Response against BCG status

```{r }
ggplot(data_mod_freq_adult %>%
         dplyr::mutate(
           bcg = factor(
             bcg, 
             levels = c("before", "after")
           )
         ), 
       aes(x = bcg, y = freq, fill = bcg)) +
  cowplot::theme_cowplot() +
  cowplot::background_grid(major = "y") +
  geom_boxplot(outlier.size = 1, 
               outlier.colour = "gray55") + 
  scale_fill_brewer(palette = "Set1", 
                    labels = short_to_display_bcg, 
                    name = "BCG") + 
  theme(axis.ticks.x = element_blank(), 
        axis.text.x = element_blank(), 
        legend.title = element_blank(), 
        legend.position = "bottom") + 
  labs(x = "BCG status", y = "Frequency") + 
  facet_wrap(~pop, ncol = 4, scales = "free_y", 
             labeller = labeller(
               pop = short_to_long_pop, 
               conf_cont = short_to_long_var_cont)) 
```

#### Confounders

##### Continuous

###### Response against variable

MAIT frequency possibly increasing with height.

```{r }
data_plot_freq_adult_cont <- data_mod_freq_adult %>%
  dplyr::select(-(age:race)) %>%
  tidyr::pivot_longer(
    age_in_years:ppd, 
    names_to = "conf_cont", 
    values_to = "value"
  )
p_cont <- ggplot(
  data_plot_freq_adult_cont, 
  aes(x = value, y = freq)
) +
  cowplot::theme_cowplot(font_size = 14) +
  cowplot::background_grid(major = "y") +
  geom_point() +
  geom_smooth(method = "loess", formula = y ~ x) +
  facet_grid(pop ~ conf_cont, 
             scales = "free", 
             labeller = labeller(
               pop = short_to_long_pop, 
               conf_cont = short_to_long_var_cont)) +
  theme(strip.background = element_blank()) +
  scale_colour_brewer(palette = "Dark2", 
                      labels = short_to_display_bcg) +
  labs(x = "Value", y = "Frequency") +
  theme(legend.title = element_blank()) +
  geom_hline(yintercept = 0)
dir.create(here::here(
    "figures",
    "fig_2", 
    "data_exp"), recursive = TRUE)
cowplot::ggsave2(
  here::here(
    "figures",
    "fig_2", 
    "data_exp", 
    "p-adult-resp_vs_conf_cont.png"
  ), 
  p_cont, 
  height = 20, 
  width = 20, 
  units = "cm"
)
```

```{r , results = "asis"}
knitr::include_graphics("figures/fig_2/data_exp/p-adult-resp_vs_conf_cont.png")
```

###### Variable by BCG status

Almost no change in underlying variables between measurement dates.

```{r }
ggplot(
  data_plot_freq_adult_cont %>%
    dplyr::group_by(conf_cont) %>%
    dplyr::mutate(value = (value - mean(value, na.rm = TRUE)) / sd(value, na.rm = TRUE)) %>%
    dplyr::ungroup(), 
  aes(x = value, col = bcg)
) +
  cowplot::theme_cowplot() +
  cowplot::background_grid(major = "y") +
  # geom_histogram(position = "dodge") +
  geom_density(bw = 0.4) +
  facet_wrap( ~ conf_cont, 
             ncol = 3, 
             scales = "free",
             labeller = labeller(
               pop = short_to_long_pop, 
               conf_cont = short_to_long_var_cont)) +
    scale_colour_brewer(palette = "Dark2", 
                      labels = short_to_display_bcg) +
    labs(x = "Standardised value", y = "Density") +
  theme(strip.background = element_blank()) +
    theme(legend.title = element_blank())
```

#### Categorical

###### Response against variable

####### Race

Extremely strong race effects, particularly for TCR $\gamma\delta$ T cells. 

```{r }
ggplot(
  data_mod_freq_adult, 
  aes(x = bcg, y = freq, fill = race, col = race)
) +
  cowplot::theme_cowplot() +
  cowplot::background_grid(major = "y") +
  geom_jitter(position = "dodge") +
  geom_boxplot(
    position = "dodge", 
    col = "black", 
    outlier.size = -1
  ) +
  facet_wrap(~pop, 
             ncol = 4, 
             scales = "free_y", 
             labeller = labeller(
               pop = short_to_long_pop, 
               conf_cont = short_to_long_var_cont))  +
  scale_fill_brewer(palette = "Set1", 
                    name = "Race") +
  scale_colour_brewer(palette = "Set1", 
                      name = "Race") +
  scale_x_discrete(labels = short_to_display_bcg) +
  labs(x = "BCG status", y = "Frequency")
```

####### Gender

Appears to be strong sex effect as well, if not as strong as race.

```{r }
ggplot(
  data_mod_freq_adult %>%
    dplyr::mutate(sex = ifelse(is.na(sex), "unknown", sex)), 
  aes(x = bcg, y = freq, fill = sex, col = sex)
) +
  cowplot::theme_cowplot() +
  cowplot::background_grid(major = "y") +
  geom_jitter(position = "dodge") +
  geom_boxplot(
    position = "dodge", 
    col = "black", 
    outlier.size = -1
  ) +
  facet_wrap(~pop, 
             ncol = 4, 
             scales = "free_y", 
             labeller = labeller(
               pop = short_to_long_pop,
               sex = short_to_display_sex
             ))  +
  scale_fill_brewer(palette = "Set2", 
                    name = "Sex",
                    labels = short_to_display_sex) +
  scale_colour_brewer(palette = "Set2", 
                      name = "Sex",
                      labels = short_to_display_sex)
```

## Analysis

### Effect of BCG

#### Infants

##### Calculation

- TODO:
  - Calculate CI for effect size
  - Calculate CI's for individual BCG groups (also for adult)
  - Calculate sd of response (within each bcg group)
    - Or, I suppose you could take the error estimate from the model
    - Then, divide the CI for the difference by this
    - This will then form the standardised effect estimate in the plot
    
- We fit a quantile regression model to the cell-type frequencies. 
  - We fit it twice - once without confounders, and once with confounders that are pre-specified and found to be associated with the response on the basis of data exploration, namely sex and race. Only age at time of visit was available for every infant as a confounder other than these two, and it was not particularly associated with BCG status or with any of the cell types' frequencies, except perhaps for CD1b and NK T cells. 
  - To calculate the standardised effect size and associated CI, we considered the following values to divide by:
    - Standard deviation of residuals of full model
    - Standard deviation of residuals of null model (i.e. model without BCG included)
    - Standard deviation of data
    - Average of standard deviation of data within BCG status
  - We considered that the standard deviation of residuals of null model is the best option, as if there are strong confounders that explain a lot of the variation, then the role of BCG relative to what is left is made larger. 
  - The next best alternative would be one of the standard deviations of the data. 
  - The worst is standard deviation of residuals of the full model, as then large effects are made more prominent both by the effect size being larger and the residual standard deviation being smaller. 
  
```{r , eval = TRUE, include = FALSE}
pop_vec <- unique(data_mod_freq_infant$pop)
pop <- "mait"
conf_vec_infant <- c(
  "none" = "", 
  "pre_specified" = "+ sex + race"#, 
  # "data_specified" = " + ethnicity + length + gest_age + weight"
  )[2]
results_tbl_fig2_infant <- purrr::map_df(pop_vec, function(pop) {
  print(pop)
  data_mod <- data_mod_freq_infant %>%
    dplyr::filter(pop == .env$pop)
  
  purrr::map_df(seq_along(conf_vec_infant), function(i) {
    print(names(conf_vec_infant)[i])
    # effect size
    
    data_mod <- data_mod %>%
      dplyr::mutate(
        freq = switch(
          .env$pop, 
          "gem" = ,
          "cd4_ifng" = freq^0.25,
          "cd4" = freq,
          log10(freq)
          ) 
      )
    
    trans_inv <- switch(
      pop, 
      "gem" = ,
      "cd4_ifng" = function(x) x^4, 
      "cd4" = function(x) x,
      function(x) 10^x
    )

    data_mod <- data_mod %>%
      dplyr::mutate(
        bcg = factor(
          bcg, 
          levels = c("no bcg", "bcg")
        )
      )
    fml_txt_base <- "freq ~ 1"
    fml_txt_null <- paste0(fml_txt_base, conf_vec_infant[i])
    fml_txt_trt <- paste0(fml_txt_null, " + bcg")
    fml_null <- eval(parse(text = fml_txt_null))
    fml_trt <- eval(parse(text = fml_txt_trt))
    data_mod <- data_mod %>%
      dplyr::mutate(
        race = factor(race, 
                      levels = c("coloured", "black"))
        )
    fit_large <- try(quantreg::rq(
      fml_trt, 
      tau = 0.5,
      data = data_mod
    ), silent = TRUE)
    fit_small <- try(quantreg::rq(
      fml_null, 
      tau = 0.5,
      data = data_mod
    ), silent = TRUE)
    
    mod_summ <- summary(fit_large, se = "rank")
    
    sd_resid <- sd(resid(mod_summ))
    
    coef_tbl <- coefficients(mod_summ) 
    ind_bcg <- which(rownames(coef_tbl) == "bcgbcg")
    coef_vec <- coef_tbl[ind_bcg, c("lower bd", "upper bd")] %>%
      as.vector()
    coef_est <- coef_tbl[ind_bcg, "coefficients"]
    
    out_tbl <- tibble::tibble(
      pop = pop,
      age = "infant",
      conf = names(conf_vec_infant)[i]
    )
    
    if(class(fit_large)[1] != "try-error") {
      out_tbl <- out_tbl %>%
        dplyr::mutate(
          diff_est = coef_est, 
          diff_lb = coef_vec[1], 
          diff_ub = coef_vec[2], 
          sd_resid_large = sd(resid(mod_summ))
        )
    } else {
      out_tbl <- out_tbl %>%
        dplyr::mutate(
          diff_est = NA, 
          diff_lb = NA, 
          diff_ub = NA, 
          sd_resid_large = NA
        )
    }
    
    if(class(fit_small)[1] != "try-error") {
      out_tbl <- out_tbl %>%
        dplyr::mutate(
          sd_resid_small = sd(resid(summary(fit_small)))
        )
    } else {
      out_tbl <- out_tbl %>%
        dplyr::mutate(
          sd_resid_small = NA
        )
    }
    
    out_tbl <- out_tbl %>%
      dplyr::mutate(
        sd_raw_overall = sd(data_mod$freq), 
        sd_raw_grp_mean = purrr::map_dbl(unique(data_mod$bcg), function(x) {
          data_mod_bcg <- data_mod %>%
            dplyr::filter(bcg == x)
          sd(data_mod_bcg$freq)
        }) %>% 
          mean()
      )
    
    if(class(fit_large)[1] != "try-error") {
      out_tbl <- out_tbl %>%
        dplyr::mutate(
          diff_est_std_resid_large = coef_est / sd_resid_large, 
          diff_lb_std_resid_large = diff_lb / sd_resid_large, 
          diff_ub_std_resid_large = diff_ub / sd_resid_large
        )
    } else {
      out_tbl <- out_tbl %>%
        dplyr::mutate(
          diff_est_std_resid_large = NA, 
          diff_lb_std_resid_large = NA, 
          diff_ub_std_resid_large = NA
        )
    }
    if(class(fit_small)[1] != "try-error") {
      out_tbl <- out_tbl %>%
        dplyr::mutate(
          diff_est_std_resid_small = coef_est / sd_resid_small, 
          diff_lb_std_resid_small = diff_lb / sd_resid_small, 
          diff_ub_std_resid_small = diff_ub / sd_resid_small
        )
    } else {
      out_tbl <- out_tbl %>%
        dplyr::mutate(
          diff_est_std_resid_small = NA, 
          diff_lb_std_resid_small = NA, 
          diff_ub_std_resid_small = NA
        )
    }
    
    out_tbl <- out_tbl %>%
      dplyr::mutate(
        diff_est_std_raw_overall = coef_est / sd_raw_overall, 
        diff_lb_std_raw_overall = diff_lb / sd_raw_overall, 
        diff_ub_std_raw_overall = diff_ub / sd_raw_overall
      ) %>%
      dplyr::mutate(
        diff_est_std_raw_grp_mean = coef_est / sd_raw_grp_mean, 
        diff_lb_std_raw_grp_mean = diff_lb / sd_raw_grp_mean, 
        diff_ub_std_raw_grp_mean = diff_ub / sd_raw_grp_mean
      )
    

    if(class(fit_large)[1] != "try-error" && 
       class(fit_small)[1] != "try-error") {
      anova_fit <- anova(fit_large, fit_small)
      p = anova_fit$table$pvalue
      out_tbl <- out_tbl %>%
        dplyr::mutate(
          diff_p = p
        )
    } else {
      out_tbl <- out_tbl %>%
        dplyr::mutate(
          diff_p = NA
        )
      }

    # Group-wise confidence intervals
    # ================================
    
    # no bcg
    
    coef_tbl <- coefficients(mod_summ) 
    ind_int <- which(rownames(coef_tbl) == "(Intercept)")
    coef_vec_est <- coef_tbl[ind_int, "coefficients"]
    coef_vec_int_ctrl <- coef_tbl[ind_int, c("lower bd", "upper bd")] %>%
      as.vector()
    out_tbl <- out_tbl %>%
      dplyr::mutate(
        ctrl_grp_est = coef_vec_est,
        ctrl_grp_lb = coef_vec_int_ctrl[1],
        ctrl_grp_ub = coef_vec_int_ctrl[2]
      )
    
    data_mod_trt <- data_mod %>%
      dplyr::mutate(
        bcg = factor(
          bcg, 
          levels = c("bcg", "no bcg")
        )
      )

    fit_large_trt <- try(quantreg::rq(
      fml_trt, 
      tau = 0.5,
      data = data_mod_trt
    ), silent = TRUE)

    mod_summ_trt <- summary(fit_large_trt)

    coef_tbl <- coefficients(mod_summ_trt) 
    ind_int <- which(rownames(coef_tbl) == "(Intercept)")
    coef_vec_est_trt <- coef_tbl[ind_int, "coefficients"]
    coef_vec_int_trt <- coef_tbl[ind_int, c("lower bd", "upper bd")] %>%
      as.vector()
    
    out_tbl <- out_tbl %>%
      dplyr::mutate(
        trt_grp_est = coef_vec_est_trt,
        trt_grp_lb = coef_vec_int_trt[1],
        trt_grp_ub = coef_vec_int_trt[2]
      )
    
    # transform CI's back to original scale
    
    out_tbl <- out_tbl %>%
      dplyr::mutate(
        ctrl_grp_est = trans_inv(ctrl_grp_est),
        ctrl_grp_lb = trans_inv(ctrl_grp_lb),
        ctrl_grp_ub = trans_inv(ctrl_grp_ub),
        trt_grp_est = trans_inv(trt_grp_est),
        trt_grp_lb = trans_inv(trt_grp_lb),
        trt_grp_ub = trans_inv(trt_grp_ub)
      )
    
    out_tbl
  })
})
```

```{r , eval = TRUE, include = FALSE}
pop_vec <- unique(data_mod_freq_adult$pop)
pop <- "mait"
conf_vec_adult <- c(
  "none" = "", 
  "pre_specified" = "+ sex + race"#, 
  # "data_specified" = " + ethnicity + length + gest_age + weight"
  )[2]
results_tbl_fig2_adult <- purrr::map_df(pop_vec, function(pop) {
  print(pop)
  data_mod <- data_mod_freq_adult %>%
    dplyr::filter(pop == .env$pop)
  
  purrr::map_df(seq_along(conf_vec_adult), function(i) {
    print(names(conf_vec_adult)[i])
    # effect size
    
    data_mod <- data_mod %>%
      dplyr::mutate(
        freq = switch(
          .env$pop, 
          "gem" = ,
          "cd4_ifng" = freq^0.25,
          "cd4" = freq,
          log10(freq)
          ) 
      )
    
    trans_inv <- switch(
      pop, 
      "gem" = ,
      "cd4_ifng" = function(x) x^4, 
      "cd4" = function(x) x,
      function(x) 10^x
    )

    data_mod <- data_mod %>%
      dplyr::mutate(
        bcg = factor(
          bcg, 
          levels = c("before", "after")
        ), 
        race = factor(
          race, 
          levels = c("non_black", "black")
        )
      )
    fml_txt_base <- "freq ~ 1"
    fml_txt_null <- paste0(fml_txt_base, conf_vec_adult[i])
    fml_txt_trt <- paste0(fml_txt_null, " + bcg")
    fml_null <- eval(parse(text = fml_txt_null))
    fml_trt <- eval(parse(text = fml_txt_trt))
    
    fit_large <- try(quantreg::rq(
      fml_trt, 
      tau = 0.5,
      data = data_mod
    ), silent = TRUE)
    fit_small <- try(quantreg::rq(
      fml_null, 
      tau = 0.5,
      data = data_mod
    ), silent = TRUE)
    
    mod_summ <- summary(fit_large, se = "rank")
    
    sd_resid <- sd(resid(mod_summ))
    
    coef_tbl <- coefficients(mod_summ) 
    ind_bcg <- which(rownames(coef_tbl) == "bcgafter")
    coef_vec <- coef_tbl[ind_bcg, c("lower bd", "upper bd")] %>%
      as.vector()
    coef_est <- coef_tbl[ind_bcg, "coefficients"]
    
    out_tbl <- tibble::tibble(
      pop = pop,
      age = "adult",
      conf = names(conf_vec_adult)[i]
    )
    
    if(class(fit_large)[1] != "try-error") {
      out_tbl <- out_tbl %>%
        dplyr::mutate(
          diff_est = coef_est, 
          diff_lb = coef_vec[1], 
          diff_ub = coef_vec[2], 
          sd_resid_large = sd(resid(mod_summ))
        )
    } else {
      out_tbl <- out_tbl %>%
        dplyr::mutate(
          diff_est = NA, 
          diff_lb = NA, 
          diff_ub = NA, 
          sd_resid_large = NA
        )
    }
    
    if(class(fit_small)[1] != "try-error") {
      out_tbl <- out_tbl %>%
        dplyr::mutate(
          sd_resid_small = sd(resid(summary(fit_small)))
        )
    } else {
      out_tbl <- out_tbl %>%
        dplyr::mutate(
          sd_resid_small = NA
        )
    }
    
    out_tbl <- out_tbl %>%
      dplyr::mutate(
        sd_raw_overall = sd(data_mod$freq), 
        sd_raw_grp_mean = purrr::map_dbl(unique(data_mod$bcg), function(x) {
          data_mod_bcg <- data_mod %>%
            dplyr::filter(bcg == x)
          sd(data_mod_bcg$freq)
        }) %>% 
          mean()
      )
    
    if(class(fit_large)[1] != "try-error") {
      out_tbl <- out_tbl %>%
        dplyr::mutate(
          diff_est_std_resid_large = coef_est / sd_resid_large, 
          diff_lb_std_resid_large = diff_lb / sd_resid_large, 
          diff_ub_std_resid_large = diff_ub / sd_resid_large
        )
    } else {
      out_tbl <- out_tbl %>%
        dplyr::mutate(
          diff_est_std_resid_large = NA, 
          diff_lb_std_resid_large = NA, 
          diff_ub_std_resid_large = NA
        )
    }
    if(class(fit_small)[1] != "try-error") {
      out_tbl <- out_tbl %>%
        dplyr::mutate(
          diff_est_std_resid_small = coef_est / sd_resid_small, 
          diff_lb_std_resid_small = diff_lb / sd_resid_small, 
          diff_ub_std_resid_small = diff_ub / sd_resid_small
        )
    } else {
      out_tbl <- out_tbl %>%
        dplyr::mutate(
          diff_est_std_resid_small = NA, 
          diff_lb_std_resid_small = NA, 
          diff_ub_std_resid_small = NA
        )
    }
    
    out_tbl <- out_tbl %>%
      dplyr::mutate(
        diff_est_std_raw_overall = coef_est / sd_raw_overall, 
        diff_lb_std_raw_overall = diff_lb / sd_raw_overall, 
        diff_ub_std_raw_overall = diff_ub / sd_raw_overall
      ) %>%
      dplyr::mutate(
        diff_est_std_raw_grp_mean = coef_est / sd_raw_grp_mean, 
        diff_lb_std_raw_grp_mean = diff_lb / sd_raw_grp_mean, 
        diff_ub_std_raw_grp_mean = diff_ub / sd_raw_grp_mean
      )
    

    if(class(fit_large)[1] != "try-error" && 
       class(fit_small)[1] != "try-error") {
      anova_fit <- anova(fit_large, fit_small)
      p = anova_fit$table$pvalue
      out_tbl <- out_tbl %>%
        dplyr::mutate(
          diff_p = p
        )
    } else {
      out_tbl <- out_tbl %>%
        dplyr::mutate(
          diff_p = NA
        )
    }
    data_mod_wsc <- data_mod %>%
      tidyr::pivot_wider(
        names_from = "bcg", 
        values_from = "freq"
      )  %>%
      dplyr::filter(!(is.na(before) | is.na(after)))
    
    wsc_test <- wilcox.test(
      x = data_mod_wsc$after, 
      y = data_mod_wsc$before,
      paired = TRUE, 
      conf.int = TRUE
    )
    diff_p_wsc <- wsc_test$p.value
    diff_est_wsc <- wsc_test$estimate
    diff_lb_wsc <- wsc_test$conf.int[1]
    diff_ub_wsc <- wsc_test$conf.int[2]
    
    out_tbl <- out_tbl %>%
      dplyr::mutate(
        diff_est_wsc = diff_est_wsc, 
        diff_lb_wsc = diff_lb_wsc, 
        diff_ub_wsc = diff_ub_wsc, 
        diff_p_wsc = diff_p_wsc
      )

    # Group-wise confidence intervals
    # ================================
    
    # no bcg
    
    coef_tbl <- coefficients(mod_summ) 
    ind_int <- which(rownames(coef_tbl) == "(Intercept)")
    coef_vec_est <- coef_tbl[ind_int, "coefficients"]
    coef_vec_int_ctrl <- coef_tbl[ind_int, c("lower bd", "upper bd")] %>%
      as.vector()
    out_tbl <- out_tbl %>%
      dplyr::mutate(
        ctrl_grp_est = coef_vec_est,
        ctrl_grp_lb = coef_vec_int_ctrl[1],
        ctrl_grp_ub = coef_vec_int_ctrl[2]
      )
    
    data_mod_trt <- data_mod %>%
      dplyr::mutate(
        bcg = factor(
          bcg, 
          levels = c("after", "before")
        )
      )

    fit_large_trt <- try(quantreg::rq(
      fml_trt, 
      tau = 0.5,
      data = data_mod_trt
    ), silent = TRUE)

    mod_summ_trt <- summary(fit_large_trt)

    coef_tbl <- coefficients(mod_summ_trt) 
    ind_int <- which(rownames(coef_tbl) == "(Intercept)")
    coef_vec_est_trt <- coef_tbl[ind_int, "coefficients"]
    coef_vec_int_trt <- coef_tbl[ind_int, c("lower bd", "upper bd")] %>%
      as.vector()
    
    out_tbl <- out_tbl %>%
      dplyr::mutate(
        trt_grp_est = coef_vec_est_trt,
        trt_grp_lb = coef_vec_int_trt[1],
        trt_grp_ub = coef_vec_int_trt[2]
      )
    
    # transform CI's back to original scale
    
    out_tbl <- out_tbl %>%
      dplyr::mutate(
        ctrl_grp_est = trans_inv(ctrl_grp_est),
        ctrl_grp_lb = trans_inv(ctrl_grp_lb),
        ctrl_grp_ub = trans_inv(ctrl_grp_ub),
        trt_grp_est = trans_inv(trt_grp_est),
        trt_grp_lb = trans_inv(trt_grp_lb),
        trt_grp_ub = trans_inv(trt_grp_ub)
      )
    
    out_tbl
  })
})
```

```{r , eval = TRUE, include = FALSE}
pop_vec <- unique(data_mod_freq_adult$pop)
pop <- "mait"
conf_vec <- c(
  "none" = "", 
  "pre_specified" = " + sex + sex:age + race + race:age + bcg + bcg:age"#, 
  # "data_specified" = " + ethnicity + length + gest_age + weight"
  )[2]
results_tbl_fig2_age <- purrr::map_df(pop_vec, function(pop) {
  print(pop)
  data_mod_adult <- data_mod_freq_adult %>%
    dplyr::filter(pop == .env$pop) %>%
    dplyr::select(pop, pid, bcg, age, sex, race, freq) %>%
    dplyr::mutate(bcg = ifelse(bcg == "after", "trt", "ctrl"))
  data_mod_infant <- data_mod_freq_infant %>%
    dplyr::filter(pop == .env$pop) %>%
    dplyr::select(pop, pid, bcg, age, sex, race, freq) %>%
    dplyr::mutate(
      race = ifelse(race != "black", "non_black", "black")
    ) %>%
    dplyr::mutate(bcg = ifelse(bcg == "bcg", "trt", "ctrl"))
  data_mod <- data_mod_adult %>%
    dplyr::bind_rows(data_mod_infant)
  
  purrr::map_df(seq_along(conf_vec_adult), function(i) {
    print(names(conf_vec_adult)[i])
    # effect size
    
    data_mod <- data_mod %>%
      dplyr::mutate(
        freq = switch(
          .env$pop, 
          "gem" = ,
          "cd4_ifng" = freq^0.25,
          "cd4" = freq,
          log10(freq)
          ) 
      )
    
    trans_inv <- switch(
      pop, 
      "gem" = ,
      "cd4_ifng" = function(x) x^4, 
      "cd4" = function(x) x,
      function(x) 10^x
    )

    data_mod <- data_mod %>%
      dplyr::mutate(
        bcg = factor(
          bcg, 
          levels = c("trt", "ctrl")
        ), 
        race = factor(
          race, 
          levels = c("non_black", "black")
        ), 
        age = factor(
          age, 
          levels = c("infant", "adult")
        )
      )
    fml_txt_base <- "freq ~ 1"
    fml_txt_null <- paste0(fml_txt_base, conf_vec[i])
    fml_txt_trt <- paste0(fml_txt_null, " + age")
    fml_null <- eval(parse(text = fml_txt_null))
    fml_trt <- eval(parse(text = fml_txt_trt))
    
    fit_large <- try(quantreg::rq(
      fml_trt, 
      tau = 0.5,
      data = data_mod
    ), silent = TRUE)
    fit_small <- try(quantreg::rq(
      fml_null, 
      tau = 0.5,
      data = data_mod
    ), silent = TRUE)
    
    mod_summ <- summary(fit_large, se = "rank")
    
    sd_resid <- sd(resid(mod_summ))
    
    coef_tbl <- coefficients(mod_summ) 
    ind_age <- which(rownames(coef_tbl) == "ageadult")
    coef_vec <- coef_tbl[ind_age, c("lower bd", "upper bd")] %>%
      as.vector()
    coef_est <- coef_tbl[ind_age, "coefficients"]
    
    out_tbl <- tibble::tibble(
      pop = pop,
      conf = names(conf_vec_adult)[i]
    )
    
    if(class(fit_large)[1] != "try-error") {
      out_tbl <- out_tbl %>%
        dplyr::mutate(
          diff_est = coef_est, 
          diff_lb = coef_vec[1], 
          diff_ub = coef_vec[2], 
          sd_resid_large = sd(resid(mod_summ))
        )
    } else {
      out_tbl <- out_tbl %>%
        dplyr::mutate(
          diff_est = NA, 
          diff_lb = NA, 
          diff_ub = NA, 
          sd_resid_large = NA
        )
    }
    
    if(class(fit_small)[1] != "try-error") {
      out_tbl <- out_tbl %>%
        dplyr::mutate(
          sd_resid_small = sd(resid(summary(fit_small)))
        )
    } else {
      out_tbl <- out_tbl %>%
        dplyr::mutate(
          sd_resid_small = NA
        )
    }
    
    out_tbl <- out_tbl %>%
      dplyr::mutate(
        sd_raw_overall = sd(data_mod$freq), 
        sd_raw_grp_mean = purrr::map_dbl(unique(data_mod$bcg), function(x) {
          data_mod_bcg <- data_mod %>%
            dplyr::filter(bcg == x)
          sd(data_mod_bcg$freq)
        }) %>% 
          mean()
      )
    
    if(class(fit_large)[1] != "try-error") {
      out_tbl <- out_tbl %>%
        dplyr::mutate(
          diff_est_std_resid_large = coef_est / sd_resid_large, 
          diff_lb_std_resid_large = diff_lb / sd_resid_large, 
          diff_ub_std_resid_large = diff_ub / sd_resid_large
        )
    } else {
      out_tbl <- out_tbl %>%
        dplyr::mutate(
          diff_est_std_resid_large = NA, 
          diff_lb_std_resid_large = NA, 
          diff_ub_std_resid_large = NA
        )
    }
    if(class(fit_small)[1] != "try-error") {
      out_tbl <- out_tbl %>%
        dplyr::mutate(
          diff_est_std_resid_small = coef_est / sd_resid_small, 
          diff_lb_std_resid_small = diff_lb / sd_resid_small, 
          diff_ub_std_resid_small = diff_ub / sd_resid_small
        )
    } else {
      out_tbl <- out_tbl %>%
        dplyr::mutate(
          diff_est_std_resid_small = NA, 
          diff_lb_std_resid_small = NA, 
          diff_ub_std_resid_small = NA
        )
    }
    
    out_tbl <- out_tbl %>%
      dplyr::mutate(
        diff_est_std_raw_overall = coef_est / sd_raw_overall, 
        diff_lb_std_raw_overall = diff_lb / sd_raw_overall, 
        diff_ub_std_raw_overall = diff_ub / sd_raw_overall
      ) %>%
      dplyr::mutate(
        diff_est_std_raw_grp_mean = coef_est / sd_raw_grp_mean, 
        diff_lb_std_raw_grp_mean = diff_lb / sd_raw_grp_mean, 
        diff_ub_std_raw_grp_mean = diff_ub / sd_raw_grp_mean
      )
    

    if(class(fit_large)[1] != "try-error" && 
       class(fit_small)[1] != "try-error") {
      mod_summ_boot <- summary(fit_large, se = "boot")
      coef_tbl <- coef(mod_summ_boot)
      ind_age <- which(rownames(coef_tbl) == "ageadult")
      p <- coef_tbl[ind_age, "Pr(>|t|)"]
      out_tbl <- out_tbl %>%
        dplyr::mutate(
          diff_p = p
        )
    } else {
      out_tbl <- out_tbl %>%
        dplyr::mutate(
          diff_p = NA
        )
    }

    # Group-wise confidence intervals
    # ================================
    
    # no bcg
    
    coef_tbl <- coefficients(mod_summ) 
    ind_int <- which(rownames(coef_tbl) == "(Intercept)")
    coef_vec_est <- coef_tbl[ind_int, "coefficients"]
    coef_vec_int_ctrl <- coef_tbl[ind_int, c("lower bd", "upper bd")] %>%
      as.vector()
    out_tbl <- out_tbl %>%
      dplyr::mutate(
        ctrl_grp_est = coef_vec_est,
        ctrl_grp_lb = coef_vec_int_ctrl[1],
        ctrl_grp_ub = coef_vec_int_ctrl[2]
      )
    
    data_mod_trt <- data_mod %>%
      dplyr::mutate(
        age = factor(
          age, 
          levels = c("adult", "infant")
        )
      )

    fit_large_trt <- try(quantreg::rq(
      fml_trt, 
      tau = 0.5,
      data = data_mod_trt
    ), silent = TRUE)

    mod_summ_trt <- summary(fit_large_trt)

    coef_tbl <- coefficients(mod_summ_trt) 
    ind_int <- which(rownames(coef_tbl) == "(Intercept)")
    coef_vec_est_trt <- coef_tbl[ind_int, "coefficients"]
    coef_vec_int_trt <- coef_tbl[ind_int, c("lower bd", "upper bd")] %>%
      as.vector()
    
    out_tbl <- out_tbl %>%
      dplyr::mutate(
        trt_grp_est = coef_vec_est_trt,
        trt_grp_lb = coef_vec_int_trt[1],
        trt_grp_ub = coef_vec_int_trt[2]
      )
    
    # transform CI's back to original scale
    
    out_tbl <- out_tbl %>%
      dplyr::mutate(
        ctrl_grp_est = trans_inv(ctrl_grp_est),
        ctrl_grp_lb = trans_inv(ctrl_grp_lb),
        ctrl_grp_ub = trans_inv(ctrl_grp_ub),
        trt_grp_est = trans_inv(trt_grp_est),
        trt_grp_lb = trans_inv(trt_grp_lb),
        trt_grp_ub = trans_inv(trt_grp_ub)
      )
    
    out_tbl
  })
})
```

###### Effect of BCG in infants

```{r , results = "asis"}
results_tbl_fig2_infant %>%
  dplyr::filter(conf == "pre_specified") %>%
  dplyr::select(pop, age, diff_est, diff_p) %>%
  dplyr::mutate(pop = short_to_long_pop[pop]) %>%
  dplyr::arrange(diff_p) %>%
  dplyr::mutate(diff_p_bonf = p.adjust(diff_p, method = "bonf")) %>%
  dplyr::rename(Pop = pop, 
                Age = age, 
                `BCG effect: est.` = `diff_est`, 
                `BCG effect: p-value` = diff_p, 
                `BCG effect: q-value (Bonf)` = diff_p_bonf) %>%
  pander::pandoc.table()
```

###### Effect of BCG in adults

```{r , results = "asis"}
results_tbl_fig2_adult %>%
  dplyr::filter(conf == "pre_specified") %>%
  dplyr::select(pop, age, diff_est, diff_p, diff_p_wsc) %>%
  dplyr::mutate(pop = short_to_long_pop[pop]) %>%
  dplyr::arrange(diff_p_wsc) %>%
  dplyr::mutate(diff_p_bonf = p.adjust(diff_p, method = "bonf")) %>%
  dplyr::mutate(diff_p_wsc_bonf = p.adjust(diff_p_wsc, method = "bonf")) %>%
  dplyr::rename(Pop = pop, 
                Age = age, 
                `BCG effect: est.` = `diff_est`, 
                `BCG effect: med p-value` = diff_p, 
                `BCG effect: wsc p-value` = diff_p_wsc, 
                `BCG effect: med q-value (Bonf)` = diff_p_bonf,
                `BCG effect: wsc q-value (Bonf)` = diff_p_wsc_bonf) %>%
  pander::pandoc.table()
```

###### Effect of age in individuals that received BCG

```{r , results = "asis"}
results_tbl_fig2_age %>%
  dplyr::filter(conf == "pre_specified") %>%
  dplyr::select(pop, diff_est, diff_p) %>%
  dplyr::mutate(pop = short_to_long_pop[pop]) %>%
  dplyr::arrange(diff_p) %>%
  dplyr::mutate(diff_p_bonf = p.adjust(diff_p, method = "bonf")) %>%
  dplyr::rename(Pop = pop, 
                `Age effect: est.` = `diff_est`, 
                `Age effect: p-value` = diff_p, 
                `Age effect: q-value (Bonf)` = diff_p_bonf) %>%
  pander::pandoc.table()
```

##### Plotting

```{r , include = FALSE}

plot_list_fig2 <- purrr::map(names(conf_vec_infant), function(conf) {
  results_tbl_fig2_infant_conf <- results_tbl_fig2_infant %>%
    dplyr::filter(conf == .env$conf) %>%
    dplyr::select(pop, diff_p, diff_est_std_resid_small:diff_ub_std_resid_small,
                  ctrl_grp_est:trt_grp_ub) %>%
      dplyr::rename(
        ctrl_est = ctrl_grp_est, 
        trt_est = trt_grp_est,
        ctrl_lb = ctrl_grp_lb, 
        ctrl_ub = ctrl_grp_ub, 
        trt_lb = trt_grp_lb, 
        trt_ub = trt_grp_ub, 
        diff_std_est = diff_est_std_resid_small, 
        diff_std_lb = diff_lb_std_resid_small,
        diff_std_ub = diff_ub_std_resid_small
      ) %>%
      dplyr::mutate(
        age = "infant"
      ) %>%
    dplyr::mutate(
      diff_p_bonf = p.adjust(diff_p, method = "bonf")
    ) %>%
    dplyr::select(
      pop, age, diff_p, diff_p_bonf, everything()
    )
  results_tbl_fig2_adult_conf <- results_tbl_fig2_adult %>%
    dplyr::filter(conf == .env$conf) %>%
    dplyr::mutate(
      diff_p = diff_p_wsc, 
      diff_est = diff_est_wsc,
      diff_lb = diff_lb_wsc, 
      diff_ub = diff_ub_wsc
    ) %>%
    dplyr::rename(
      ctrl_est = ctrl_grp_est, 
      trt_est = trt_grp_est,
      ctrl_lb = ctrl_grp_lb, 
      ctrl_ub = ctrl_grp_ub, 
      trt_lb = trt_grp_lb, 
      trt_ub = trt_grp_ub
    ) %>%
    dplyr::mutate(
      diff_std_est = diff_est / sd_resid_small,
      diff_std_lb = diff_lb / sd_resid_small,
      diff_std_ub = diff_ub / sd_resid_small
    ) %>%
    dplyr::mutate(
      age = "adult"
    ) %>%
    dplyr::mutate(
      diff_p_bonf = p.adjust(diff_p, method = "bonf")
    ) %>%
    dplyr::select(pop, age, diff_p, diff_p_bonf, ctrl_est:trt_ub,
          diff_std_est:diff_std_ub) 
  
  results_tbl_fig2_age_conf <- results_tbl_fig2_age %>%
    dplyr::filter(conf == .env$conf) %>%
    dplyr::select(pop, diff_p, diff_est_std_resid_small:diff_ub_std_resid_small,
                ctrl_grp_est:trt_grp_ub) %>%
    dplyr::rename(
      ctrl_est = ctrl_grp_est, 
      trt_est = trt_grp_est,
      ctrl_lb = ctrl_grp_lb, 
      ctrl_ub = ctrl_grp_ub, 
      trt_lb = trt_grp_lb, 
      trt_ub = trt_grp_ub, 
      diff_std_est = diff_est_std_resid_small, 
      diff_std_lb = diff_lb_std_resid_small,
      diff_std_ub = diff_ub_std_resid_small
    ) %>%
    dplyr::mutate(
      age = "-"
    ) %>%
  dplyr::mutate(
    diff_p_bonf = p.adjust(diff_p, method = "bonf")
  ) %>%
  dplyr::select(
    pop, diff_p, diff_p_bonf, everything()
    )
  
  results_tbl_fig2_conf <- results_tbl_fig2_infant_conf %>%
    dplyr::bind_rows(results_tbl_fig2_adult_conf)
  pop_vec_conf <- unique(results_tbl_fig2_conf$pop)
  #pop_vec_conf <- "cd4"
  pop <- pop_vec_conf[1]
  
  purrr::map(pop_vec_conf, function(pop) {
    
    # Group plot
    # =====================
    plot_tbl_results_raw <- results_tbl_fig2_conf %>%
      dplyr::filter(pop == .env$pop)
    plot_tbl_results_tidy <- plot_tbl_results_raw %>%
      dplyr::select(age, ctrl_est:trt_ub) %>%
      tidyr::pivot_longer(
        -age, 
        names_to = "type", 
        values_to = "value"
      ) %>%
      tidyr::separate(
        col = type, 
        into = c("trt", "stat"), 
        sep = "_"
      ) %>%
      dplyr::mutate(
        trt = paste0(age, "_", trt)
        ) %>%
      dplyr::mutate(
        trt = purrr::map_chr(trt, function(x) {
          switch(
            x,
            "infant_ctrl" = "No BCG", 
            "infant_trt" = "BCG", 
            "adult_ctrl" = "Before", 
            "adult_trt" = "After", 
            stop(paste0(x, " not recognised"))
            )
          }), 
        trt = factor(
          trt, 
          levels = c(
            "No BCG", 
            "BCG", 
            "Before", 
            "After"
          )
        )
      ) %>%
      tidyr::pivot_wider(
        names_from = stat, 
        values_from = value
      ) %>%
      dplyr::mutate(
        ub = pmax(ub, est, lb), 
        est = pmax(est, lb),
        lb = pmin(ub, est, lb),
        est = pmin(ub, est)
      )
    
    plot_tbl_raw_tidy_infant <- data_mod_freq_infant %>%
      dplyr::filter(pop == .env$pop) %>%
      dplyr::select(bcg, freq) %>%
      dplyr::mutate(
        bcg = ifelse(bcg %in% c("nobcg", "no bcg"), "No BCG", "BCG")
      ) 
    plot_tbl_raw_tidy_adult <- data_mod_freq_adult %>%
      dplyr::filter(pop == .env$pop) %>%
      dplyr::select(bcg, freq) %>%
      dplyr::mutate(
        bcg = stringr::str_to_title(bcg)
      )
    plot_tbl_raw_tidy <- plot_tbl_raw_tidy_infant %>%
      dplyr::bind_rows(plot_tbl_raw_tidy_adult) %>%
      dplyr::rename(trt = bcg) %>%
      dplyr::mutate(
        trt = factor(
          trt, 
          levels = c(
            "No BCG", 
            "BCG", 
            "Before", 
            "After"
          )
        )
      )
    
    trans_y <- switch(
      pop, 
      "gem" = ,
      "cd4_ifng" = "sqrt", 
      "cd4" = "identity",
      "log10"
    )
    
    p_grp <- ggplot(plot_tbl_results_tidy, 
           aes(x = trt)) +
      cowplot::theme_cowplot() + 
      cowplot::background_grid(major = "y") +
      ggforce::geom_sina(
        data = plot_tbl_raw_tidy, 
        aes(y = freq, col = trt), 
        alpha = 0.5
      ) +
      scale_colour_manual(
        values = trt_to_col
      ) +
      geom_errorbar(
        data = plot_tbl_results_tidy,
        aes(ymin = lb, ymax = ub), 
        alpha = 0.8, 
        width = 0.6
      ) +
      geom_point(
        data = plot_tbl_results_tidy,
        aes(y = est), 
        col = "black",
        alpha = 1, size = 2
      ) +
      scale_y_continuous(trans = trans_y) +
      labs(y = pop_to_lab_freq[[pop]]) +
      guides(colour = "none") +
      theme(axis.text.x = element_text(angle = 45, 
                                       vjust = 0.675), 
            axis.title.x = element_blank()) 
    
    p_grp <- switch(
      pop, 
      "mait" = p_grp +
        scale_y_continuous(
          breaks = c(0.01, 0.1, 1, 6), 
          trans = trans_y, 
          limits = c(NA, 14)
        ),
      "nkt" = p_grp +
        scale_y_continuous(
          breaks = c(0.03, 0.1, 0.3, 1, 3), 
          trans = trans_y, 
          limits = c(NA, 3.6)
        ),
      "cd1b" = p_grp +
        scale_y_continuous(
          breaks = c(0.03, 0.1, 0.3, 1, 3), 
          trans = trans_y, 
          limits = c(NA, 3.6)
        ),
      "gem" = p_grp +
        scale_y_continuous(
          breaks = c(0.000, 0.001, 0.003, 0.006, 0.01, 0.016), 
          trans = trans_y, 
          limits = c(0, 0.02)
        ), 
      "gd" = p_grp +
        scale_y_continuous(
          breaks = c(0.3, 1, 3, 10),
          trans = trans_y, 
          limits = c(NA, 16)
        ), 
      "cd4" = p_grp +
        scale_y_continuous(
          breaks = c(40, 60, 80, 100),
          trans = trans_y, 
          limits = c(NA, 102)
        ), 
      "cd4_ifng" = p_grp +
        scale_y_continuous(
          breaks = c(0, 0.1, 0.5, 1, 2, 4, 8), 
          trans = trans_y, 
          limits = c(0, 9)
        ), 
      p_grp
    )
    
    p_tbl_bcg <- plot_tbl_results_raw %>%
      dplyr::select(pop:diff_p_bonf) %>%
      dplyr::mutate(var_exp = "bcg")
    p_tbl_age <- results_tbl_fig2_age_conf %>%
      dplyr::filter(pop == .env$pop) %>%
      dplyr::select(pop:diff_p_bonf) %>%
      dplyr::mutate(var_exp = "age") %>%
      dplyr::mutate(age = "-")
    p_tbl <- p_tbl_bcg %>%
      dplyr::bind_rows(p_tbl_age) %>%
      dplyr::select(pop, var_exp, age, diff_p, diff_p_bonf)
    
    # Standardised effect size plot
    
    # =====================
    
    plot_tbl_results_tidy <- plot_tbl_results_raw %>%
      dplyr::select(age, diff_std_est:diff_std_ub) %>%
      tidyr::pivot_longer(
        -age, 
        names_to = "type", 
        values_to = "value"
      ) %>%
      tidyr::pivot_wider(
        names_from = type, 
        values_from = value
      )
    
    lab_y <- pop_to_lab_freq_diff[pop][[1]]

    p_diff <- ggplot(data = plot_tbl_results_tidy, 
                     mapping = aes(x = age)) +
      cowplot::theme_cowplot() + 
      cowplot::background_grid(major = "y") + 
      geom_hline(yintercept = 0, size = 0.5) + 
      geom_errorbar(
        aes(ymin = diff_std_lb, ymax = diff_std_ub),
        width = 0.6
      ) +
      geom_point(
        aes(y = diff_std_est), size = 1.8
      ) +
      expand_limits(y= c(-2, 2)) +
      scale_x_discrete(
        labels = short_to_display_age, 
        limits = c("infant", "adult")
      ) +
      labs(x = "age", y = lab_y) +
      theme(axis.title.x = element_blank(), 
            axis.text.x = element_text(angle = 45, vjust = 0.675))
    
    p_inf <- p_tbl %>%
      dplyr::filter(age == "infant") %>%
      dplyr::pull("diff_p")
    p_inf_txt <- ifelse(p_inf < 0.0001, 
                        "< 0.0001", 
                        paste0(" = ", signif(p_inf, 2)))
    p_inf_txt <- paste0("p ", p_inf_txt)
    p_inf_b <- p_tbl %>%
      dplyr::filter(age == "infant") %>%
      dplyr::pull("diff_p_bonf")
    p_inf_b_txt <- ifelse(p_inf_b < 0.0001, 
                    "< 0.0001", 
                    paste0("= ", signif(p_inf_b, 2)))
    p_inf_b_txt <- paste0("(q ", p_inf_b_txt, ")")
    p_inf_txt_disp <- paste0(p_inf_txt, "\n", p_inf_b_txt)
    
    p_ad <- p_tbl %>%
      dplyr::filter(age == "adult") %>%
      dplyr::pull("diff_p")
    p_ad_txt <- ifelse(p_ad < 0.0001, 
                        " < 0.0001", 
                        paste0(" = ", signif(p_ad, 2)))
    p_ad_txt <- paste0("p ", p_ad_txt)
    p_ad_b <- p_tbl %>%
      dplyr::filter(age == "adult") %>%
      dplyr::pull("diff_p_bonf")
    p_ad_b_txt <- ifelse(p_ad_b < 0.0001, 
                    " < 0.0001", 
                    paste0(" = ", signif(p_ad_b, 2)))
    p_ad_b_txt <- paste0("(q ", p_ad_b_txt, ")")
    p_ad_txt_disp <- paste0(p_ad_txt, "\n", p_ad_b_txt)
    p_age <- results_tbl_fig2_age_conf %>%
      dplyr::filter(pop == .env$pop) %>%
      dplyr::pull("diff_p")
    p_age_txt <- ifelse(p_age < 0.0001, 
                        " < 0.0001", 
                        paste0(" = ", signif(p_age, 2)))
    p_age_txt <- paste0("p", p_age_txt)
    
    q_age <- results_tbl_fig2_age_conf %>%
      dplyr::filter(pop == .env$pop) %>%
      dplyr::pull("diff_p_bonf")
    q_age_txt <- ifelse(q_age < 0.0001, 
                        " < 0.0001", 
                        paste0(" = ", signif(q_age, 2)))
    q_age_txt <- paste0("q", q_age_txt)
  
    
    nudge_freq <- switch(
      pop, 
      "gem" = 0, 
      "mait" = ,
      "cd1b" = ,
      "gd" = ,
      "nkt" = 0.025,
      "cd4" = 0.0375,
      "cd4_ifng" = 0.05
    )
    p <- cowplot::ggdraw() + 
      cowplot::draw_plot(
        p_grp, 
        x = nudge_freq,
        width = 2 / 3 - nudge_freq, 
        height = 0.84
      ) +
      cowplot::draw_plot(
        p_diff, 
        x = 2 / 3, 
        width = 1 / 3, 
        y = 0.05, 
        height = 0.84 - 0.05
      ) 
    
    q_nudge <- 0.02
    y <-  0.96 - (0:2) / 1e1 * 1/2 + c(0, 0, 0.0125)
    line_length <- 0.15
    tick_height <- 0.01
    text_size <- 9
    line_size <- 1
    
    pop_to_x_inf <- function(pop) {
      switch(
        pop, 
        "mait", 
        "nkt", 
        "cd1b", 
        "gd" = c(0.2713, 0.375)
      )
    }
    pop_to_x_inf <- c(0.2925, 0.389)
    pop_to_x_ad <- function(pop) {
      switch(
        pop, 
        "mait", 
        "nkt", 
        "cd1b", 
        "gd" = c(0.476, 0.5825)
      )
    }
    pop_to_x_ad <- c(0.483, 0.585)
    

    p_out <- p %>%
      ggutils::add_p_value(
        p_txt = p_inf_txt,
        q_txt = p_inf_b_txt,
        line_x = pop_to_x_inf,
        p_nudge = 0, 
        q_nudge = 0, 
        tick_nudge_in = 0.00375,
        y = y - 0.13, 
        tick_height = tick_height, 
        text_size = text_size, 
        line_size = line_size
      ) %>%
      ggutils::add_p_value(
        p_txt = p_ad_txt,
        q_txt = p_ad_b_txt,
        line_x = pop_to_x_ad,
        p_nudge = 0, 
        q_nudge = 0, 
        tick_nudge_in = 0.00375,
        y = y - 0.13, 
        tick_height = tick_height, 
        text_size = text_size, 
        line_size = line_size
      ) %>%
      ggutils::add_p_value(
        p_txt = p_age_txt,
        q_txt = q_age_txt,
        line_x = c(pop_to_x_inf[2], pop_to_x_ad[2]),
        p_nudge = 0, 
        q_nudge = 0, 
        tick_nudge_in = 0.00375,
        y = y, 
        tick_height = tick_height, 
        text_size = text_size, 
        line_size = line_size
      ) 
    
    p_out
    
  }) %>%
    setNames(pop_vec_conf)
}) %>%
  setNames(names(conf_vec_infant))


p_fig2 <- cowplot::plot_grid(
  plotlist = plot_list_fig2$pre_specified, 
  ncol = 2
)
ggutils::add_guide_lines(
  p = p_fig2, 
  range = c(0.5 ,0.5)
) %>%
  ggutils::add_guide_lines(
    range = 0.56, n = 3
  )
dir.create(here::here("_book", "figures"), recursive = TRUE)
cowplot::ggsave2(
  here::here(
    "_book", 
    "figures",
    "fig_2.pdf"
  ), 
  p_fig2, 
  height = 29, 
  width = 19, 
  units = "cm"
)
cowplot::ggsave2(
  here::here(
    "_book", 
    "figures", 
    "fig_2.png"
  ), 
  p_fig2, 
  height = 29, 
  width = 19, 
  units = "cm"
)
```

```{r , results = "asis"}
knitr::include_graphics("_book/figures/fig_2.png")
```
